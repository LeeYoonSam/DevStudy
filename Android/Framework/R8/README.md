# R8 최적화란 무엇인가요?

**R8**은 안드로이드 빌드 프로세스에서 APK 또는 AAB의 크기를 줄이고 런타임 성능을 향상시키는 데 사용되는 **코드 축소(shrinking) 및 최적화 도구**입니다. 이전의 ProGuard 도구를 대체하며 안드로이드 빌드 시스템에 원활하게 통합되어 코드 축소, 최적화, 난독화(obfuscation) 및 리소스 관리를 위한 고급 기능을 제공합니다.

### R8 작동 방식

R8은 빌드 단계에서 애플리케이션의 코드를 처리하여 다음을 달성합니다.

1.  **코드 축소 (Code Shrinking):** 애플리케이션의 코드베이스에서 사용되지 않는 클래스, 메서드, 필드 및 속성을 제거하여 최종 APK 또는 AAB 크기를 줄입니다.
2.  **최적화 (Optimization):** 런타임 성능을 향상시키기 위해 코드를 단순화하고 재구성합니다. 여기에는 메서드 인라이닝, 중복 코드 제거, 유사 코드 블록 병합 등이 포함됩니다.
3.  **난독화 (Obfuscation):** 클래스, 메서드, 필드의 원래 이름을 변경하여 모호하게 만들어 리버스 엔지니어링을 더 어렵게 만듭니다.
4.  **리소스 최적화 (Resource Optimization):** 사용되지 않는 리소스(예: 레이아웃, 드로어블, 문자열)를 제거하여 앱의 공간 점유(footprint)를 더욱 최소화합니다.

### R8 최적화의 주요 기능

  * **사용되지 않는 코드 제거 (Dead Code Removal):** R8은 코드베이스를 분석하여 앱에서 도달할 수 없거나 사용되지 않는 코드를 식별하고 제거합니다.
  * **인라이닝 (Inlining):** 짧은 메서드나 함수를 호출 코드에 직접 삽입하여 메서드 호출 오버헤드를 줄이고 런타임 성능을 향상시킵니다.
  * **클래스 병합 (Class Merging):** 유사한 클래스나 인터페이스를 하나로 결합하여 메모리 공간 점유를 줄이고 효율성을 향상시킵니다.
  * **도달 불가능한 코드 제거 (Unreachable Code Elimination):** 절대 실행되지 않는 코드 경로를 완전히 제거합니다.
  * **상수 폴딩 및 전파 (Constant Folding and Propagation):** 가능한 경우 표현식을 단순화하고 변수를 해당 상수 값으로 대체합니다.
  * **난독화 (Obfuscation):** R8은 코드 내의 의미 있는 이름을 더 짧고 덜 설명적인 이름으로 대체하여 앱 크기를 줄이고 리버스 엔지니어링을 더 어렵게 만듭니다.

### R8 설정 (Configuration)

R8은 설정을 위해 ProGuard 규칙을 사용합니다. 코드의 어떤 부분을 축소, 난독화 또는 최적화에서 제외해야 하는지 지정할 수 있습니다. 일반적인 사용 사례는 다음과 같습니다.

  * **리플렉션을 위한 코드 보존:** 리플렉션을 통해 접근하는 클래스나 메서드는 ProGuard 규칙에 명시적으로 유지(`keep`)해야 합니다.
  * **타사 라이브러리 제외:** 일부 라이브러리는 기능 손상을 피하기 위해 특정 규칙이 필요할 수 있습니다.

클래스를 유지하기 위한 ProGuard 규칙 예시:

```proguard
-keep class com.example.MyClass { *; }
```

### R8의 장점

  * **긴밀한 통합:** R8은 안드로이드 빌드 시스템에 내장되어 있어 일반적인 ProGuard 규칙 외에 추가 설정이 거의 필요 없습니다.
  * **향상된 효율성:** 축소, 최적화, 난독화를 단일 패스(한 번의 처리 과정)로 결합하여 ProGuard보다 빠르고 효율적입니다.
  * **앱 크기 감소:** 사용되지 않는 코드와 리소스를 제거하여 최종 APK 또는 AAB 크기를 크게 줄입니다.
  * **향상된 보안:** 난독화는 공격자가 앱을 리버스 엔지니어링하는 것을 더 어렵게 만들어 지적 재산을 보호합니다.

### R8의 한계점

  * **과도한 축소 위험:** 올바르게 설정하지 않으면 R8이 간접적으로 참조되는 코드나 리소스를 제거하여 런타임 오류를 유발할 수 있습니다.
  * **복잡한 설정:** 복잡한 프로젝트, 특히 리플렉션이나 동적 클래스 로딩을 사용하는 프로젝트의 경우 ProGuard 규칙 작성이 까다로울 수 있습니다.
  * **디버깅 어려움:** 난독화는 스택 트레이스에 난독화된 이름이 포함될 수 있어 디버깅을 더 어렵게 만들 수 있습니다.

### 요약

R8은 현대 안드로이드 개발에서 필수적인 도구로, 포괄적인 코드 축소, 최적화 및 난독화 기능을 제공합니다. 앱 크기를 줄이고 런타임 성능을 향상시키며 보안을 강화함으로써 R8은 개발자가 효율적이고 컴팩트한 애플리케이션을 제공하는 데 도움을 줍니다. ProGuard 규칙을 사용한 적절한 설정은 의도하지 않은 필수 코드 제거를 방지하고 원활한 앱 기능을 보장하는 데 매우 중요합니다. 더 자세한 정보는 Jake Wharton의 글, [R8 Optimization: Staticization](https://jakewharton.com/r8-optimization-staticization/)을 읽어볼 수 있습니다.

---

## Q. R8 최적화는 앱 성능을 어떻게 향상시키고 APK/AAB 크기를 어떻게 줄이나요?

R8은 안드로이드 빌드 프로세스에서 사용되는 강력한 코드 최적화 및 축소 도구입니다. R8을 통해 앱의 성능을 향상시키고 최종 빌드 파일(APK/AAB)의 크기를 효과적으로 줄일 수 있습니다.

### 1. R8을 통한 앱 성능 향상 방법

R8은 다음과 같은 다양한 코드 최적화 기법을 적용하여 앱의 런타임 성능을 개선합니다.

#### 1.1. 주요 코드 최적화 기법

* **메서드 인라이닝 (Method Inlining):**
    * 작거나 자주 호출되는 메서드의 코드를 해당 메서드를 호출하는 지점에 직접 삽입합니다.
    * **효과:** 메서드 호출에 따르는 오버헤드(예: 스택 프레임 생성 및 제거)를 줄여 실행 속도를 높입니다.

* **사용되지 않는/도달 불가능한 코드 제거 (Dead/Unreachable Code Elimination):**
    * 앱 실행 흐름 분석을 통해 절대로 실행될 수 없는 코드 경로(도달 불가능한 코드)나 사용되지 않는 코드(데드 코드)를 식별하고 제거합니다.
    * **효과:** 실행 시 관리해야 할 코드의 양을 줄여 잠재적으로 분기 예측(branch prediction) 및 CPU의 명령어 캐시 효율성을 향상시킬 수 있습니다.

* **클래스 병합 (Class Merging):**
    * 유사한 구조나 인터페이스를 가진 클래스들이 타입 검사 등에 의해 구분될 필요가 없을 경우, R8은 이들을 하나의 클래스로 병합할 수 있습니다.
    * **효과:** 런타임에 로드하고 관리해야 하는 클래스의 수를 줄여 클래스 로딩 시간을 단축시키고 메모리 공간 점유(footprint)를 감소시켜 간접적으로 성능에 기여할 수 있습니다.

* **상수 폴딩 및 전파 (Constant Folding and Propagation):**
    * 컴파일 시점에 상수 표현식을 미리 계산하고(폴딩), 변수 대신 해당 상수 값을 코드 전체에 전파합니다.
    * **효과:** 런타임에 수행해야 할 계산 작업을 줄여 실행 속도를 높입니다. 예를 들어, `final int SIZE = 10 * 2;`는 `final int SIZE = 20;`으로 대체됩니다.

* **중복 코드 제거 (Removing Redundant Code):**
    * 이미 계산된 결과가 있거나 불필요한 검사 등 중복되거나 의미 없는 코드를 제거합니다.
    * **효과:** 불필요한 연산을 줄여 실행 효율성을 높입니다.

* **Enum 최적화:**
    * 많은 경우 Enum(열거형)을 정수(int)로 변환하여 Enum 클래스 및 관련 메서드 호출에 따른 객체 생성 및 오버헤드를 줄입니다.
    * **효과:** Enum 사용으로 인한 성능 저하를 최소화합니다.

#### 1.2. 크기 감소로 인한 간접적인 성능 이점

R8에 의한 코드 및 리소스 크기 감소는 다음과 같은 간접적인 성능 향상 효과도 가져옵니다.

* **더 빠른 로딩 속도:** 앱의 코드가 작아지면 디스크에서 읽어 메모리에 로드하는 데이터 양이 줄어들어 앱 시작 시간 및 특정 기능 로딩 시간이 단축될 수 있습니다.
* **향상된 CPU 캐시 활용도:** 더 작은 코드는 CPU의 명령어 캐시(instruction cache)에 더 잘 적재될 수 있어 캐시 미스(cache miss)를 줄이고 실행 속도를 높이는 데 기여합니다.
* **메모리 공간 점유 감소 및 GC 압박 완화:** 사용되지 않는 코드를 제거하고 구조를 최적화하면 앱 코드 세그먼트의 메모리 점유가 줄어듭니다. 이는 데이터 및 다른 작업을 위한 가용 메모리를 늘리고, 결과적으로 가비지 컬렉션(GC) 발생 빈도와 부담을 줄여 GC로 인한 앱 멈춤(pause) 현상을 최소화하고 전반적인 반응성을 향상시킵니다.

### 2. R8을 통한 APK/AAB 크기 감소 방법

R8은 주로 다음과 같은 방식을 통해 최종 빌드 파일의 크기를 줄입니다.

#### 2.1. 코드 축소 (Code Shrinking) - 가장 직접적인 방법

* **사용되지 않는 코드 제거:** R8은 앱의 진입점(예: 액티비티, 서비스 등)과 개발자가 ProGuard 규칙을 통해 명시적으로 유지하도록 지정한 코드를 시작으로 전체 코드의 사용 여부를 분석합니다. 이 분석을 통해 도달 불가능하거나 전혀 사용되지 않는 클래스, 메서드, 필드를 식별하고 최종 `.dex` 파일에서 완전히 제거합니다. 이는 앱 자체 코드뿐만 아니라 포함된 라이브러리의 사용되지 않는 부분까지 포함합니다.

#### 2.2. 리소스 축소 (안드로이드 그래들 플러그인과 연동)

* R8이 주로 코드에 집중하는 동안, 안드로이드 그래들 플러그인의 리소스 축소 기능과 함께 작동하여 더 효과적인 크기 감소를 이룹니다. R8에 의해 사용되지 않는 코드가 제거되면, 해당 코드에서만 참조되던 리소스(예: 드로어블, 레이아웃, 문자열 등)들도 더 정확하게 식별되어 제거될 수 있습니다.

#### 2.3. 난독화 (Obfuscation) - 간접적인 크기 감소 기여

* 클래스, 메서드, 필드의 이름을 `a`, `b`, `c`와 같이 짧고 의미 없는 이름으로 변경합니다. 난독화의 주 목적은 리버스 엔지니어링을 어렵게 만드는 것이지만, 이렇게 짧아진 이름들은 `.dex` 파일 내의 문자열 풀(string pool)이나 심볼 테이블에서 차지하는 공간을 줄여 파일 크기를 미미하게나마 감소시키는 데 기여합니다.

#### 2.4. 크기 감소에도 기여하는 최적화 기법

* 위에서 언급된 일부 코드 최적화 기법들(예: 메서드 인라이닝 중 일부 경우, 클래스 병합, 중복 코드 제거, Enum 최적화)은 결과적으로 전체 코드의 양을 줄여 파일 크기 감소에도 긍정적인 영향을 미칩니다.

### 결론

R8 최적화는 코드 축소, 다양한 코드 최적화 기법, 그리고 난독화를 통해 앱의 최종 빌드 파일(APK/AAB) 크기를 효과적으로 줄입니다. 이렇게 줄어든 크기와 최적화된 코드는 앱의 로딩 속도 향상, 런타임 성능 개선, 메모리 사용량 감소, 그리고 CPU 캐시 효율성 증대 등 전반적인 사용자 경험 향상으로 이어집니다. 따라서 R8은 현대 안드로이드 앱 개발에서 필수적인 최적화 도구로 활용됩니다.

---

## Q. R8은 ProGuard와 어떻게 다르며, 어떤 장점을 제공하나요?

## R8과 ProGuard의 차이점 및 R8의 장점

R8과 ProGuard는 모두 안드로이드 애플리케이션의 코드를 최적화하고(optimization), 축소하며(shrinking), 난독화(obfuscation)하는 데 사용되는 도구입니다. 하지만 R8은 ProGuard를 대체하여 안드로이드 그래들 플러그인(Android Gradle Plugin, AGP) 3.4.0 버전부터 기본 도구로 사용되고 있으며, 여러 가지 차이점과 장점을 제공합니다.

### 1. R8과 ProGuard의 주요 차이점

#### 1.1. 기본 도구 및 통합 수준

* **ProGuard:** AGP 3.4.0 이전 버전까지 기본 코드 최적화 도구였습니다. 그래들 플러그인이 외부 Java 도구인 ProGuard를 호출하는 방식으로 작동했습니다.
* **R8:** AGP 3.4.0 버전부터 기본 도구로 채택되었습니다. `build.gradle` 파일에서 `minifyEnabled true`를 설정하면 R8이 사용됩니다. R8은 D8 dexer(덱서)와 함께 안드로이드 빌드 프로세스에 훨씬 더 긴밀하게 통합되어 있습니다.

#### 1.2. 처리 방식 및 단계

* **ProGuard:** 일반적으로 코드 축소, 최적화, 난독화 작업을 별도의 순차적인 단계(pass)로 수행했습니다.
* **R8:** 코드 축소, 최적화, 난독화 및 덱싱(dexing, `.dex` 파일로 변환)까지의 과정을 보다 통합된 방식, 종종 **단일 패스(single pass)** 또는 더 적은 패스로 처리합니다. 이는 전반적인 최적화 효율성과 빌드 속도 향상에 기여합니다.

#### 1.3. 최적화 범위 및 수준

* **ProGuard:** 주로 일반적인 자바 바이트코드 최적화 기능을 제공했습니다.
* **R8:** 안드로이드 환경에 특화되어 설계되었으며, 일반적으로 ProGuard보다 더 고급스럽고 안드로이드에 타겟팅된 최적화 기능을 제공합니다. 예를 들어, 더 효과적인 메서드 인라이닝, 라이브러리 코드에 대한 더 나은 데드 코드 제거, 클래스 병합, Enum 최적화, 그리고 오래된 안드로이드 버전을 위한 최신 자바 언어 기능 디슈가링(desugaring) 지원 등이 개선되었습니다.

#### 1.4. 빌드 속도

* **ProGuard:** 여러 단계를 거치고 덜 통합된 방식으로 인해 빌드 속도가 상대적으로 느릴 수 있었습니다.
* **R8:** 통합된 처리 방식과 효율성 덕분에 일반적으로 ProGuard보다 **더 빠른 빌드 시간**을 제공합니다.

#### 1.5. 결과물 크기 (APK/AAB)

* **ProGuard:** 코드 크기를 줄이는 데 효과적이었습니다.
* **R8:** 더 적극적이고 효과적인 축소 및 최적화 기술을 통해 ProGuard보다 **더 작은 최종 빌드 파일 크기**를 만들어내는 경우가 많습니다.

#### 1.6. 코틀린(Kotlin) 지원

* **ProGuard:** 코틀린은 컴파일 시 추가적인 메타데이터나 합성 클래스/메서드를 생성하는데, ProGuard는 매우 구체적인 `-keep` 규칙 없이는 이를 항상 최적으로 처리하지 못할 수 있었습니다.
* **R8:** 코틀린이 생성하는 바이트코드와 메타데이터에 대한 이해도가 높아, 코틀린 프로젝트에서 종종 더 적은 수의 특화된 `-keep` 규칙만으로도 코틀린 코드를 더 효과적으로 축소하고 최적화할 수 있습니다.

#### 1.7. 설정 파일 호환성

* **R8과 ProGuard 모두 동일한 ProGuard 규칙 구문** (`-keep`, `-dontwarn` 등)을 사용합니다. 따라서 기존에 사용하던 ProGuard 규칙 파일(`proguard-rules.pro`)은 대부분 R8에서도 호환됩니다.

#### 1.8. 개발 주체 및 유지보수

* **ProGuard:** GuardSquare에서 개발한 범용 자바 최적화 도구입니다.
* **R8:** Google에서 안드로이드 플랫폼을 위해 특별히 개발하고 적극적으로 유지보수하고 있어, 안드로이드 플랫폼 변경 사항과 새로운 최적화 기회에 빠르게 대응합니다.

### 2. R8 사용의 장점 (ProGuard 대비)

위에서 언급된 차이점들로부터 R8 사용의 다음과 같은 장점들이 도출됩니다.

1.  **더 나은 런타임 성능:** R8의 더 고급스럽고 안드로이드에 특화된 최적화는 종종 앱의 실제 실행 성능 향상으로 이어집니다.
2.  **더 작은 APK/AAB 크기:** 일반적으로 R8이 ProGuard보다 코드 축소 및 최적화에 더 효과적이어서 최종 앱 크기가 더 작아집니다. 이는 사용자 다운로드 시간 단축 및 설치 공간 절약에 기여합니다.
3.  **더 빠른 빌드 시간:** 통합된 단일 패스(또는 더 적은 패스) 방식은 빌드 과정을 더 빠르게 만듭니다.
4.  **향상된 코틀린(Kotlin) 지원:** 코틀린 프로젝트에서 R8은 코드를 더 잘 이해하고 최적화하여, 때로는 더 적은 수의 유지 규칙만으로도 효과적인 결과를 얻을 수 있습니다.
5.  **안드로이드 빌드 도구와의 긴밀한 통합:** 안드로이드 그래들 플러그인의 일부로 작동하므로 D8 덱서와 같은 다른 빌드 단계와 더 원활하게 연동됩니다.
6.  **Google의 지속적인 안드로이드 특화 개발 및 지원:** 안드로이드 플랫폼의 발전에 맞춰 R8도 지속적으로 개선되고 지원됩니다.
7.  **ProGuard 규칙 호환성:** 기존 ProGuard 설정을 대부분 재사용할 수 있어 R8로의 전환이 비교적 용이합니다.

결론적으로, R8은 ProGuard의 기능을 계승하면서 안드로이드 환경에 더욱 최적화된 성능, 빌드 속도, 결과물 크기, 그리고 개발 편의성을 제공하는 현대 안드로이드 개발의 표준 코드 최적화 도구입니다.