# Bluetooth LE 란?

### 블루투스 클래식
- 무선 헤드셋과 같은 일반적인 품목에 널리 사용되어 이전에 사용했을 가능성이 가장 높은 블루투스 버전
- 음악 스트리밍과 같은 애플리케이션에 적합
- 데이터 처리량은 연결 문제나 패킷 손실 없이 지원할 수 있을 만큼 충분히 높을 뿐만 아니라 사용하기도 매우 쉬움
- 시간이 지나면 스마트폰과 무선 스피커를 충전필요

### 블루투스 저에너지(LE)
- 저전력 웨어러블이나 대규모 IoT 애플리케이션의 경우, 특히 빠른 데이터 전송 속도가 필요하지 않은 경우 배터리를 자주 충전하는 것은 불가능
- 블루투스 핵심 사양 버전 4.0부터 블루투스 SIG(Special Interest Group)는 저전력 IoT 애플리케이션을 위한 핵심 요소로 활용하기 위해 블루투스 저에너지(LE)를 도입

## Bluetooth LE 특징
Bluetooth LE는 이름에서 알 수 있듯이 데이터 전송률을 희생하여 낮은 에너지 소비를 달성하는 데 중점을 둡니다. 
여기서 데이터 속도를 희생한다는 것은 두 가지 메커니즘을 의미합니다. 

- 첫째, 데이터 패킷이 27바이트에서 251바이트로 더 작게 만들어집니다. 
- 둘째, 전력 소비의 중요한 요인인 긴 라디오 온 시간을 피하기 위해 데이터를 가능한 한 적게 전송합니다. 

따라서 Bluetooth LE는 최소한의 전력으로 작동하고 소량의 데이터만 전송해야 하는 **배터리 작동식 장치**에 더 적합합니다.

블루투스 LE는 지원되는 토폴로지 및 노드 유형 등 다른 측면에서도 블루투스 클래식과 다릅니다. 이는 Bluetooth LE가 Bluetooth 클래식과 완전히 다른 사용 사례를 위해 고안되었기 때문에 다른 네트워크 토폴로지가 필요하기 때문입니다.

요약 | 측정치
--- | ---
Operating band | 2400 MHz – 2483.5 MHz ~ 2.4 GHz
Channel bandwidth	| 2 MHz
Number of RF channels	| 40
Maximum transmit power	| 20 dBm / 0.1 W
Maximum application data throughput	| 1.4 Mbps
Maximum range at reduced data rates (125 & 500 kbps) | ~1000 m

### Bluetooth LE 장점
- Bluetooth 저에너지의 주요 장점은 다른 저전력 개인 영역 네트워크에 비해 비용이 저렴하여 대량 배포가 필요한 애플리케이션에 적합하다는 점입니다.
- 이 기술은 스마트폰에도 널리 보급되어 있어(대부분의 스마트폰은 블루투스 클래식과 블루투스 LE를 모두 지원) 어디서나 애플리케이션을 쉽게 테스트하고 프로토타입을 만들 수 있습니다. 양방향 통신을 테스트하려면 스마트폰 외에 Bluetooth LE 장치가 하나 더 필요합니다. 거의 모든 사람이 스마트폰을 가지고 있기 때문에 특정 하드웨어가 필요한 다른 기술에 비해 테스트에 필요한 비용과 복잡성을 줄일 수 있습니다.

## Bluetooth LE protocol stack
애플리케이션에서 Bluetooth LE를 활성화하고 사용하기 위해 프로토콜 스택의 모든 개별 계층에 대한 깊은 이해가 절대적으로 필요한 것은 아닙니다. 하지만 여러 계층의 기본 사항과 주요 기능 중 일부를 이해하면 Bluetooth LE 스택의 내부에서 어떤 일이 일어나고 있는지 파악하는 데 도움이 됩니다. 

아래는 프로토콜 스택 아키텍처를 보여 주며, 어떤 계층이 **Bluetooth LE 호스트**를 구성하고 어떤 계층이 **Bluetooth LE 컨트롤러**를 구성하는지 보여줍니다.


계층 | 설명
--- | ---
Application | 사용자가 API를 통해 블루투스 LE 프로토콜을 사용하기 위해 상호 작용하는 계층
Host | Bluetooth LE 장치가 서로 데이터를 저장하고 교환하는 방법을 결정
Controller | 하위 계층을 구성하며, 가장 눈에 띄는 부분은 전파를 생성하고 전송하려는 데이터로 신호를 인코딩하는 물리적 라디오

### Host
- Logical Link Control & Adaptation Protocol (L2CAP): 상위 계층에 데이터 캡슐화 서비스를 제공합니다.
- Security Manager Protocol (SMP): 보안 통신을 위한 방법을 정의하고 제공합니다.
- Attribute Protocol (ATT): 한 장치가 특정 데이터를 다른 장치에 노출할 수 있도록 합니다.
- Generic Attribute Profile (GATT): ATT 계층을 사용하는 데 필요한 하위 절차를 정의합니다.
- Generic Access Profile (GAP): 애플리케이션과 직접 인터페이스하여 장치 검색 및 연결 관련 서비스를 처리합니다.

### Controller
- Physical Layer (PHY): 실제 데이터가 전파로 변조되는 방식과 송수신 방법을 결정합니다.
- Link Layer (LL): 대기, 광고, 스캐닝, 시작, 연결 중 하나로 정의되는 무선 상태를 관리합니다.


# GAP: Device roles and topologies
Bluetooth LE 프로토콜은 연결 지향 통신과 브로드캐스트 통신이라는 두 가지 통신 스타일을 지원합니다.

### 정의
- **Connection-oriented communication(연결 중심의 커뮤니케이션)**: 장치 간에 전용 연결이 있는 경우 양방향 통신을 형성합니다.
- **Broadcast communication(방송 커뮤니케이션)**: 장치가 먼저 연결을 설정하지 않고 범위 내의 모든 장치에 데이터 패킷을 브로드캐스팅하여 통신하는 경우.

## Device roles(디바이스 역할)
- GAP 계층은 Bluetooth LE 네트워크의 노드에 대한 특정 장치 역할을 정의합니다. 이러한 역할은 디바이스가 자신의 존재를 알리는 방법이나 다른 노드를 검색하고 연결하는 방법과 같은 중요한 측면을 결정합니다.
- 광고 및 스캔은 Bluetooth LE 장치가 서로의 존재와 연결 가능성을 인식하는 프로세스를 말합니다. 두 Bluetooth LE 장치가 서로 연결하려면 한 장치가 자신의 존재와 연결 의사를 광고하고 다른 장치가 그러한 장치를 검색해야 합니다.

### 정의
**Advertising(광고)**: 데이터를 브로드캐스트하거나 다른 디바이스에서 검색할 수 있도록 광고 패킷을 전송하는 프로세스입니다.
**Scanning(스캐닝)**: 광고 패킷을 수신 대기하는 프로세스입니다.

## Central and peripheral(중앙 및 주변 장치)
- 앞의 예에서 자신의 존재와 연결 의사를 알리는 디바이스는 주변 장치 역할을 합니다. 
- 반면 광고를 스캔하는 디바이스는 중앙 디바이스입니다. 
- 주변 장치의 광고 패킷이 중앙에서 스캔되면 중앙은 주변 장치에 연결 요청을 보내 연결을 시작할 수 있습니다. 그러면 주변 장치와 중앙 장치가 연결이 설정되었다고 합니다.

### Definition
- **Central(중앙)**: 주변 장치를 검색하고 주변 장치와의 연결을 시작하는 장치 역할입니다.
- **Peripheral(주변 장치)**: 중앙에서 연결을 알리고 수락하는 장치 역할입니다.

중앙 장치는 동시에 두 개 이상의 주변 장치에 연결 요청을 보낼 수 있으며, 이 연결에서 호스트 역할을 맡습니다. 주변 기기는 연결이 설정된 후 광고 프로세스를 다시 시작하여 다른 중앙 기기의 연결 요청을 수락할 수도 있습니다.

중앙은 호스트 역할을 하므로 연결 관리 및 대부분의 데이터 처리와 같은 일반적인 호스트 역할의 의무를 담당합니다. 즉, 일반적으로 주변기기는 중앙 기기보다 전력을 적게 사용합니다.

리소스 제약이 있고 저전력이 필요한 IoT 장치는 일반적으로 Bluetooth LE 연결의 주변 장치인 반면, 중앙 장치는 더 많은 전력을 사용하는 휴대폰과 같은 장치입니다.

## Broadcaster and observer
- 장치는 다른 장치와 연결되지 않고 정보만 브로드캐스트하기를 원합니다. 이 경우 브로드캐스터라고 하는 특수한 종류의 주변 장치가 광고 패킷을 전송할 수 있지만 패킷을 수신하거나 연결 요청을 허용하지 않을 수 있습니다.
- 브로드캐스트되는 정보는 광고 패킷에 포함됩니다. 브로드캐스터의 가장 좋은 예는 비콘 디바이스입니다. 비콘 디바이스는 특정 디바이스에 연결할 필요 없이 정보만 전송합니다. 
- 다른 쪽에서는 옵저버라고 하는 특별한 종류의 중앙 장치가 광고 패킷을 수신하지만 연결을 시작하기 위한 연결 요청을 보내지 않습니다.

### Definition
- **Broadcaster(브로드캐스터)**: 연결 요청을 수락하지 않고 광고 패킷을 브로드캐스트하는 특수한 종류의 주변기기입니다.
- **Observer(옵저버)**: 연결을 시작하지 않고 광고 패킷을 수신하는 특별한 종류의 중앙 장치입니다.

## Network topologies
이제 Bluetooth LE 디바이스의 다양한 역할을 설정했으므로, Bluetooth LE로 가능한 다양한 네트워크 토폴로지에서 디바이스 역할이 어떻게 사용되는지 살펴봅시다.

### Broadcast topology
- 브로드캐스트 토폴로지에서는 디바이스가 연결을 설정하지 않고도 데이터 전송이 이루어집니다. 이는 광고 패킷을 사용하여 패킷을 수신할 수 있는 범위 내에 있는 모든 장치에 데이터를 브로드캐스트하는 방식으로 이루어집니다. 
- 주변 장치(보다 구체적으로 브로드캐스터)가 데이터를 광고하면 중앙 장치(보다 구체적으로 옵저버)가 광고 패킷에서 데이터를 스캔하고 읽습니다.
- 이러한 유형의 통신은 일반적으로 근접 비콘, 실내 내비게이션, 그리고 저전력 디바이스로 소량의 데이터를 여러 디바이스에 동시에 전송해야 하는 기타 여러 애플리케이션에 사용됩니다.
- 브로드캐스트 토폴로지의 장점은 브로드캐스트할 수 있는 디바이스 수에 제한이 없다는 것입니다. 광고 패킷 범위 내에 있는 모든 디바이스가 정보를 수신할 수 있습니다. 또한 연결 지향 통신보다 전력 효율이 훨씬 높습니다. 하지만 광고 패킷에 사용할 수 있는 데이터가 제한되어 있기 때문에 처리량이 제한됩니다. 또한 수신 디바이스로부터의 승인도 없습니다.

### Connected topology
- 연결된 네트워크 토폴로지는 데이터 전송이 발생하기 전에 연결을 설정합니다.
- 브로드캐스트 토폴로지와 달리 통신은 양방향으로 이루어집니다.

하나의 중앙이 세 개의 주변 장치와 통신을 설정하고 그 주변 장치 중 하나가 이미 다른 두 개의 중앙에 연결되어 있는 연결된 토폴로지

커넥티드 토폴로지의 장점은 통신 전에 직접 링크를 설정하면 처리량이 증가한다는 것입니다. 또한 통신이 양방향으로 이루어지므로 주변 장치가 중앙 장치에 브로드캐스팅만 하고 아무것도 수신하지 못하는 브로드캐스팅과 달리 중앙 장치와 주변 장치가 서로 통신할 수 있습니다.

블루투스 5.4에 응답을 수반하는 주기적 광고(PAwR)가 도입되면서 비연결 모드에서 양방향 통신이 가능해졌습니다.

### Multi-role topology
하나의 디바이스가 여러 가지 역할을 동시에 수행할 수도 있습니다. 예를 들어, 동일한 디바이스가 어떤 환경에서는 주변 장치로, 다른 환경에서는 중앙 장치로 작동할 수 있습니다.

다중 역할 기능은 허브라고 하는 디바이스가 여러 센서로부터 센서 데이터를 수신하는 동시에 이 데이터를 휴대폰으로 전달하려는 시스템에서 자주 사용됩니다. 이 경우 허브는 중앙 역할을 하며 여러 센서(주변 장치)에 연결할 수 있고, 주변 장치 역할을 하며 하나 이상의 스마트폰(중앙 장치)으로 센서 데이터를 전송할 수도 있습니다.

# ATT & GATT: Data representation and exchange(데이터 표현 및 교환)
광고 중 통신은 장치 검색 또는 데이터 브로드캐스팅에만 사용되며 GAP 계층 자체에서 처리합니다. 그러나 연결을 설정한 후에는 양방향 데이터 교환이 필요합니다. 이를 위해서는 이러한 목적에 맞는 특정 데이터 구조와 프로토콜이 필요합니다.

`ATT(속성 프로토콜)` 계층과 그 바로 위에 있는 `GATT(일반 속성 프로토콜)` 계층은 Bluetooth LE 장치 간에 데이터가 표현되고 교환되는 방식을 정의합니다. 연결이 설정되기 전에 발생하는 광고 프로세스를 처리하는 GAP 계층과 달리, **ATT 및 GATT 계층은 연결이 설정된 후의 단계와 관련**이 있습니다.

## The Attribute Protocol
- ATT 계층은 Bluetooth LE 장치의 연결 단계에서 데이터가 전송, 수신 및 처리되는 기반입니다. 
- 이 계층은 서버가 데이터를 보관하고 클라이언트에 직접 전송하거나 클라이언트가 서버에서 데이터를 폴링할 수 있는 클라이언트-서버 아키텍처를 기반으로 합니다.
- 이 계층에서 정의된 클라이언트 및 서버 역할은 GAP 계층에서 정의된 주변 및 중앙 역할과는 독립적으로 할당됩니다. 따라서 중앙은 클라이언트 또는 서버가 될 수도 있고, 주변 장치와 마찬가지로 서버가 될 수도 있습니다. 이는 모두 애플리케이션 사용 사례와 전송되는 데이터의 성격에 따라 달라집니다.
- 대부분의 경우, 주변 장치는 데이터를 수집하고 보관하는 장치이므로 주변 장치는 서버가 됩니다. 마찬가지로 중앙은 서버로부터 데이터를 수신하는 장치이므로 일반적으로 클라이언트가 됩니다.
- 이러한 역할은 GATT 계층에서 사용되므로 흔히 GATT 서버와 GATT 클라이언트라고 합니다.

### Definition
- **GATT Server**: 데이터를 저장하고 GATT 클라이언트가 데이터에 액세스할 수 있는 방법을 제공하는 장치입니다.
- **GATT Client**: 특정 GATT 작업을 통해 GATT 서버의 데이터에 접근하는 장치입니다.

ATT 계층은 GATT 서버에서 데이터를 저장하는 데 사용되는 속성이라는 데이터 구조를 정의합니다. 서버는 동시에 여러 가지 속성을 보유할 수 있습니다.

### Definition
- **Attribute**: ATT 프로토콜에서 정의한 표준화된 데이터 표현 형식입니다.

## The Generic Attribute Profile(일반 속성 프로필)
일반 속성 프로파일(GATT) 계층은 ATT 계층 바로 위에 위치하며, 프로파일, 서비스 및 특성으로 속성을 계층적으로 분류하여 그 위에 구축됩니다. GATT 계층은 이러한 개념을 사용하여 Bluetooth LE 장치 간의 데이터 전송을 관리합니다.

## Profiles, services and characteristics(프로필, 서비스 및 특성)
심박수를 측정하는 센서 장치를 예로 들어 보겠습니다. 심박수 값은 특성 값 속성이라는 속성으로 저장됩니다. 또한 특성 선언 속성이라고 하는 값 속성에 저장된 데이터에 대한 메타데이터를 포함하는 또 다른 속성이 있습니다. 이 두 속성을 합쳐서 특성이라고 합니다. 이 예에서는 심박수 측정 특성입니다.

모든 특성은 서비스라는 이름으로 묶여 있습니다. 서비스는 일반적으로 여러 특성을 포함합니다. 이 예에서는 심박수 측정 특성이 심박수 서비스에 포함되어 있습니다. 이 서비스에는 예를 들어 신체 센서 위치 특성과 같은 다른 특성도 있습니다.

그리고 그 위에 프로필은 동일한 사용 사례를 다루는 하나 이상의 서비스입니다. 심박수 서비스는 심박수 프로필에서 장치 정보 서비스와 함께 찾을 수 있습니다. 장치 정보 서비스에는 제조업체 이름 특성 및 펌웨어 개정판 특성과 같은 특성이 포함되어 있습니다.

# PHY: Radio modes
Bluetooth LE 스택의 맨 아래에는 물리 계층(PHY)이 있습니다. PHY는 Bluetooth LE 무선의 작동을 관장하는 물리 계층 무선 사양을 말합니다. 이 계층은 Bluetooth LE 무선 송신기가 채택하는 다양한 변조 및 코딩 체계를 정의하며, 이는 무선 처리량 등에 영향을 미칩니다. 이에 따라 디바이스의 배터리 소모량이나 연결 범위가 변경됩니다.

## 1M PHY
1M PHY(1메가비트 PHY)는 모든 Bluetooth LE 장치에서 지원하는 클래식 PHY입니다. 이름에서 알 수 있듯이 1M PHY는 초당 1메가비트를 사용합니다.

두 Bluetooth LE 장치 간에 연결을 시작할 때 우선 이 모드가 사용됩니다. 그런 다음 두 장치가 모두 다른 모드를 지원하는 경우 피어는 다른 모드를 요청할 수 있습니다.

## 2M PHY
2메가비트 PHY는 Bluetooth v5.0에 도입된 새로운 모드입니다. 이름에서 알 수 있듯이 이 모드는 데이터 전송 속도를 초당 2메가비트, 즉 2Mbps로 두 배로 효과적으로 높여줍니다. 데이터가 더 높은 데이터 전송률(더 빠르게)로 전송되므로 무전기를 켜두는 시간이 줄어들어 배터리 사용량이 줄어듭니다. 단점은 수신기 감도가 감소하여 통신 범위가 줄어든다는 것입니다.

## 코딩된 PHY
데이터 전송률을 높이기 위해 범위를 희생할 의향이 있는 사용자를 위해 2M PHY가 존재하는 반면, 코딩된 PHY는 데이터 전송률을 희생하여 더 긴 통신 범위를 달성할 수 있는 애플리케이션을 지원하기 위해 도입되었습니다. 코딩된 PHY는 패킷 오류를 보다 효과적으로 수정하기 위해 코딩 체계를 사용하며, 이는 또한 단일 비트가 1개 이상의 심볼로 표현된다는 것을 의미합니다. 코딩된 PHY는 S=2와 S=8의 두 가지 모드를 사용합니다. S=2 모드에서는 2개의 심볼이 1비트를 나타내므로 데이터 전송률은 500kbps입니다. S=8 모드에서는 8개의 심볼이 1비트를 나타내는 데 사용되며 데이터 전송률은 125kbps가 됩니다.